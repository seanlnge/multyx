!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.Multyx=e():t.Multyx=e()}(self,(()=>(()=>{"use strict";var t={376:(t,e,o)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Controller=void 0;const i=o(210);e.Controller=class{constructor(t){this.listening=new Set,this.ws=t,this.keys={},this.mouse={x:NaN,y:NaN,down:!1,centerX:0,centerY:0,scaleX:1,scaleY:1},document.addEventListener("keydown",(t=>{this.keys[t.code]?this.listening.has("keyhold")&&this.relayInput("keyhold",{code:t.code}):(this.keys[t.code]=!0,this.listening.has(t.code)&&this.relayInput("keydown",{code:t.code}))})),document.addEventListener("keyup",(t=>{delete this.keys[t.code],this.listening.has(t.code)&&this.relayInput("keyup",{code:t.code})})),document.addEventListener("mousedown",(t=>{this.mouse.down=!0,this.listening.has("mousedown")&&this.relayInput("mousedown")})),document.addEventListener("mouseup",(t=>{this.mouse.down=!1,this.listening.has("mouseup")&&this.relayInput("mouseup")})),document.addEventListener("mousemove",(t=>{this.mouse.x=(t.clientX-this.mouse.centerX)/this.mouse.scaleX,this.mouse.y=(t.clientY-this.mouse.centerY)/this.mouse.scaleY,this.listening.has("mousemove")&&this.relayInput("mousemove",{x:this.mouse.x,y:this.mouse.y})}))}mapCanvasPosition(t,e){var o,i,s,n,r,a,l,h,u,c,f,m,d,p,b,g;const v="top"in e,w="bottom"in e,y="left"in e,M="right"in e,x=e.anchor,C=t.getBoundingClientRect(),j=(t,...e)=>{const o=t?"Cannot include value for ":"Must include value for ",i=1==e.length?e[0]:e.slice(0,-1).join(", ")+(t?" and ":" or ")+e.slice(-1)[0],s=x?" if anchoring at "+x:" if not anchoring";console.error(o+i+s)},E=C.width/C.height,N=C.height/C.width;if(x){if("center"==x){if(v&&w&&e.top!==-e.bottom||y&&M&&e.left!==-e.right)return j(!0,"top","bottom","left","right");v?(e.left=y?e.left:M?-e.right:-Math.abs(E*e.top),e.right=y?-e.left:M?e.right:Math.abs(E*e.top),e.bottom=-e.top):w?(e.left=y?e.left:M?-e.right:-Math.abs(E*e.bottom),e.right=y?-e.left:M?e.right:Math.abs(E*e.bottom),e.top=-e.bottom):y?(e.top=v?e.top:w?-e.bottom:-Math.abs(N*e.left),e.bottom=v?-e.top:w?e.bottom:Math.abs(N*e.left),e.right=-e.left):M&&(e.top=v?e.top:w?-e.bottom:-Math.abs(N*e.right),e.bottom=v?-e.top:w?e.bottom:Math.abs(N*e.right),e.left=-e.right)}else if("bottom"==x){if(!y&&!M&&!v)return j(!1,"left","right","top");if(e.bottom)return j(!0,"bottom");e.bottom=0,y?(null!==(o=e.top)&&void 0!==o||(e.top=Math.abs(N*e.left*2)),null!==(i=e.right)&&void 0!==i||(e.right=-e.left)):M?(null!==(s=e.top)&&void 0!==s||(e.top=Math.abs(N*e.right*2)),null!==(n=e.left)&&void 0!==n||(e.left=-e.right)):(e.left=-Math.abs(E*e.top/2),e.right=-e.left)}else if("top"==x){if(!y&&!M&&!w)return j(!1,"left","right","bottom");if(e.top)return j(!0,"top");e.top=0,y?(null!==(r=e.bottom)&&void 0!==r||(e.bottom=Math.abs(N*e.left*2)),null!==(a=e.right)&&void 0!==a||(e.right=-e.left)):M?(null!==(l=e.bottom)&&void 0!==l||(e.bottom=Math.abs(N*e.right*2)),null!==(h=e.left)&&void 0!==h||(e.left=-e.right)):(e.left=-Math.abs(E*e.bottom/2),e.right=-e.left)}else if("left"==x){if(!v&&!w&&!M)return j(!1,"top","bottom","right");if(y)return j(!0,"left");e.left=0,v?(null!==(u=e.right)&&void 0!==u||(e.right=-Math.abs(E*e.top*2)),null!==(c=e.bottom)&&void 0!==c||(e.bottom=-e.top)):w?(null!==(f=e.right)&&void 0!==f||(e.right=Math.abs(E*e.bottom*2)),null!==(m=e.top)&&void 0!==m||(e.top=-e.bottom)):(e.top=-Math.abs(N*e.right/2),e.bottom=-e.top)}else if("right"==x){if(!v&&!w&&!y)return j(!1,"top","bottom","left");if(M)return j(!0,"right");e.right=0,v?(null!==(d=e.left)&&void 0!==d||(e.left=-Math.abs(E*e.top*2)),null!==(p=e.bottom)&&void 0!==p||(e.bottom=-e.top)):w?(null!==(b=e.left)&&void 0!==b||(e.left=Math.abs(E*e.bottom*2)),null!==(g=e.top)&&void 0!==g||(e.top=-e.bottom)):(e.top=-Math.abs(N*e.right/2),e.bottom=-e.top)}else if("topleft"==x){if(!M&&!w)return j(!1,"right","bottom");if(y||v)return j(!0,"left","top");e.left=e.top=0,M?e.bottom=Math.abs(N*e.right):e.right=Math.abs(E*e.bottom)}else if("topright"==x){if(!y&&!w)return j(!1,"left","bottom");if(M||v)return j(!0,"right","top");e.right=e.top=0,y?e.bottom=Math.abs(N*e.left):e.left=Math.abs(E*e.bottom)}else if("bottomleft"==x){if(!M&&!v)return j(!1,"right","top");if(w||y)return j(!0,"bottom","left");e.left=e.bottom=0,M?e.top=Math.abs(N*e.right):e.right=Math.abs(E*e.top)}else if("bottomright"==x){if(!v&&!y)return j(!1,"top","left");if(M||w)return j(!0,"bottom","right");e.right=e.bottom=0,y?e.top=Math.abs(N*e.left):e.left=Math.abs(E*e.top)}}else{if(!v&&!w)return j(!1,"top","bottom");if(w?v||(e.top=e.bottom-t.height):e.bottom=e.top+t.height,!y&&!M)return j(!1,"left","right");M?y||(e.left=e.right-t.width):e.right=e.left+t.width}const O=t.getContext("2d");O.setTransform(1,0,0,1,0,0),t.width=Math.floor(Math.abs(e.right-e.left)),t.height=Math.floor(Math.abs(e.bottom-e.top)),e.right<e.left&&O.scale(-1,1),e.top>e.bottom&&O.scale(1,-1),O.translate(-e.left,-e.top)}mapMousePosition(t,e,o=document.body,i=1,s=i){const n=window.innerWidth/(o instanceof HTMLCanvasElement?o.width:o.clientWidth),r=window.innerHeight/(o instanceof HTMLCanvasElement?o.height:o.clientHeight),a=o.getBoundingClientRect();this.mouse.centerX=a.left+t*n,this.mouse.centerY=a.top+e*r,this.mouse.scaleX=i*n,this.mouse.scaleY=s*r}mapMouseToCanvas(t){const e=t.getContext("2d").getTransform(),o=t.getBoundingClientRect();console.log(o);const i=o.width/t.width,s=o.height/t.height;this.mouse.centerX=o.left+e.e*i,this.mouse.centerY=o.top+e.f*s,this.mouse.scaleX=i*e.a,this.mouse.scaleY=s*e.d}addUnpacked(t){t.forEach((t=>{this.listening.add(t)}))}relayInput(t,e){if(console.log(this.mouse),1!==this.ws.readyState)throw new Error("Websocket connection is "+(2==this.ws.readyState?"closing":"closed"));this.ws.send(i.Message.Native(Object.assign({instruction:"input",input:t},e?{data:e}:{})))}}},210:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.Message=void 0;class o{constructor(t,e,o=!1){this.name=t,this.data=e,this.time=Date.now(),this.native=o}static BundleOperations(t,e){return Array.isArray(e)||(e=[e]),JSON.stringify(new o("_",{operations:e,deltaTime:t}))}static Native(t){return JSON.stringify(new o("_",t,!0))}static Parse(t){const e=JSON.parse(t);return"_"==e.name[0]&&(e.name=e.name.slice(1)),new o(e.name,e.data,""==e.name)}static Create(t,e){if(0==t.length)throw new Error("Multyx message cannot have empty name");if("_"==t[0]&&(t="_"+t),"function"==typeof e)throw new Error("Multyx data must be JSON storable");return JSON.stringify(new o(t,e))}}e.Message=o},787:(t,e)=>{Object.defineProperty(e,"__esModule",{value:!0}),e.EditWrapper=e.isProxy=void 0,e.Lerp=function t(e,o){if(!o){for(const o in e)t(e,o);return}let i={value:e[o],time:Date.now()},s={value:e[o],time:Date.now()};Object.defineProperty(e,o,{get:()=>{let t=Math.min(1,(Date.now()-s.time)/(s.time-i.time));return Number.isNaN(t)&&(t=0),s.value*t+i.value*(1-t)},set:t=>Date.now()-s.time<10?(s.value=t,!0):(i=Object.assign({},s),s={value:t,time:Date.now()},!0)})},e.Interpolate=function(t,e,o){let i={value:t[e],time:Date.now()},s={value:t[e],time:Date.now()};Object.defineProperty(t,e,{get:()=>{const t=s.time-i.time;let e=o[0],n=o[0];for(const i of o)t>i.time&&i.time>e.time&&(e=i),t<i.time&&i.time<n.time&&(n=i);const r=(t-e.time)/(n.time-e.time),a=e.progress+r*(n.progress-e.progress);return Number.isNaN(a)?i.value:s.value*a+i.value*(1-a)},set:t=>Date.now()-s.time<10?(s.value=t,!0):(i=Object.assign({},s),s={value:t,time:Date.now()},!0)})},e.BuildConstraint=function(t,e){return"min"==t?t=>t>=e[0]?t:e[0]:"max"==t?t=>t<=e[0]?t:e[0]:t=>t},e.isProxy=Symbol("isProxy"),e.EditWrapper=class{constructor(t){this.data=t}}}},e={};function o(i){var s=e[i];if(void 0!==s)return s.exports;var n=e[i]={exports:{}};return t[i](n,n.exports,o),n.exports}var i={};return(()=>{var t=i;const e=o(210),s=o(787),n=o(376);t.default=new class{constructor(){this.Start="_start",this.Connection="_connection",this.Lerp=s.Lerp,this.Interpolate=s.Interpolate,this.ws=new WebSocket("ws://localhost:8080/"),this.ping=0,this.events=new Map,this.self={},this.constraintTable={},this.controller=new n.Controller(this.ws),this.ws.onmessage=t=>{const o=e.Message.Parse(t.data);if(this.ping=2*(Date.now()-o.time),o.native)return this.parseNativeEvent(o);o.name in this.events&&this.events[o.name](o.data)}}on(t,e){var o;const i=null!==(o=this.events.get(t))&&void 0!==o?o:[];i.push(e),this.events.set(t,i)}send(t,o){"_"===t[0]&&(t="_"+t),this.ws.send(e.Message.Create(t,o))}forAll(t){1==this.ws.readyState?Object.values(this.clients).forEach((e=>t(e))):new Promise((t=>this.on(this.Start,t))).then((()=>{console.log(this.ws.readyState,this.clients),Object.values(this.clients).forEach((e=>t(e)))})),this.on(this.Connection,t)}parseNativeEvent(t){var e,o;for(const i of t.data)if("init"==i.instruction)this.uuid=i.client.uuid,this.joinTime=i.client.joinTime,this.self=i.client.self,this.unpackConstraints(i.constraintTable),this.controller.addUnpacked(i.client.controller),this.clients=i.clients,this.setupClientProxy(),(null!==(e=this.events.get(this.Start))&&void 0!==e?e:[]).forEach((t=>t()));else if("edit"==i.instruction){let t=this.clients;i.path.unshift(i.uuid);for(const e of i.path.slice(0,-1))t=t[e];t[i.path.slice(-1)[0]]=t[s.isProxy]?new s.EditWrapper(i.value):i.value}else"conn"==i.instruction&&(this.clients[i.uuid]=i.data,(null!==(o=this.events.get(this.Connection))&&void 0!==o?o:[]).forEach((t=>t(i.data))))}unpackConstraints(t){!function t(e,o,i){for(const[n,r]of Object.entries(o)){if("object"==typeof e[n]){t(e[n],r,i[n]={});continue}const o=i[n]={};for(const[t,e]of Object.entries(r))o[t]=(0,s.BuildConstraint)(t,e)}}(this.self,t,this.constraintTable)}setupClientProxy(){const t=new WeakSet,o=this;this.self=function i(n,r=[]){let a=o.constraintTable;for(const t of r){if(!(t in a))break;a=a[t]}return new Proxy(n,{get:(e,o)=>o===s.isProxy||("object"!=typeof n[o]||t.has(n[o])||(n[o]=i(n[o],[...r,o]),t.add(n[o])),n[o]),set(t,i,l){if(l===n[i])return!0;if(l instanceof s.EditWrapper)return n[i]=l.data,!0;if(!(i in n)||"object"==typeof l)throw new Error(`Cannot alter shape of Multyx object shared with server. Attempting to set ${r.join(".")+"."+i} to ${l}`);let h=l;if(i in a)for(const t of Object.values(a[i]))h=t(h);return n[i]===h||(n[i]=h,o.ws.send(e.Message.Native({instruction:"edit",path:[...r,i],value:h}))),!0},deleteProperty(){throw new Error("Cannot alter shape of Multyx object shared with server")}})}(this.self),this.clients[this.uuid]=this.self}}})(),i.default})()));