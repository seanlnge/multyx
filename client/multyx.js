!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.Multyx=t():e.Multyx=t()}(self,(()=>(()=>{"use strict";var e={376:(e,t,s)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Controller=void 0;const n=s(210);t.Controller=class{constructor(e){this.listening=new Set,this.ws=e,this.keys={},this.mouse={x:NaN,y:NaN,down:!1,centerX:0,centerY:0,scaleX:1,scaleY:1},document.addEventListener("keydown",(e=>{this.keys[e.code]?this.listening.has("keyhold")&&this.relayInput("keyhold",{code:e.code}):(this.keys[e.code]=!0,this.listening.has(e.code)&&this.relayInput("keydown",{code:e.code}))})),document.addEventListener("keyup",(e=>{delete this.keys[e.code],this.listening.has(e.code)&&this.relayInput("keyup",{code:e.code})})),document.addEventListener("mousedown",(e=>{this.mouse.down=!0,this.listening.has("mousedown")&&this.relayInput("mousedown")})),document.addEventListener("mouseup",(e=>{this.mouse.down=!1,this.listening.has("mouseup")&&this.relayInput("mouseup")})),document.addEventListener("mousemove",(e=>{this.mouse.x=(e.clientX-this.mouse.centerX)/this.mouse.scaleX,this.mouse.y=(e.clientY-this.mouse.centerY)/this.mouse.scaleY,this.listening.has("mousemove")&&this.relayInput("mousemove",{x:this.mouse.x,y:this.mouse.y})}))}mapMousePosition(e,t=0,s=0,n=1,i=n){const o=window.innerWidth/(e instanceof HTMLCanvasElement?e.width:e.clientWidth),r=window.innerHeight/(e instanceof HTMLCanvasElement?e.height:e.clientHeight);this.mouse.centerX=t*o,this.mouse.centerY=s*r,this.mouse.scaleX=n*o,this.mouse.scaleY=i*r}addUnpacked(e){e.forEach((e=>{this.listening.add(e)}))}relayInput(e,t){if(1!==this.ws.readyState)throw new Error("Websocket connection is "+(2==this.ws.readyState?"closing":"closed"));this.ws.send(n.Message.Native(Object.assign({instruction:"input",input:e},t?{data:t}:{})))}}},210:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.Message=void 0;class s{constructor(e,t,s=!1){this.name=e,this.data=t,this.time=Date.now(),this.native=s}static BundleOperations(e,t){return Array.isArray(t)||(t=[t]),JSON.stringify(new s("_",{operations:t,deltaTime:e}))}static Native(e){return JSON.stringify(new s("_",e,!0))}static Parse(e){const t=JSON.parse(e);return"_"==t.name[0]&&(t.name=t.name.slice(1)),new s(t.name,t.data,""==t.name)}static Create(e,t){if(0==e.length)throw new Error("Multyx message cannot have empty name");if("_"==e[0]&&(e="_"+e),"function"==typeof t)throw new Error("Multyx data must be JSON storable");return JSON.stringify(new s(e,t))}}t.Message=s},787:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.EditWrapper=t.isProxy=void 0,t.Lerp=function(e,t){let s={value:e[t],time:Date.now()},n={value:e[t],time:Date.now()};Object.defineProperty(e,t,{get:()=>{let e=Math.min(1,(Date.now()-n.time)/(n.time-s.time));return Number.isNaN(e)&&(e=0),n.value*e+s.value*(1-e)},set:e=>Date.now()-n.time<10?(n.value=e,!0):(s=Object.assign({},n),n={value:e,time:Date.now()},!0)})},t.Interpolate=function(e,t,s){let n={value:e[t],time:Date.now()},i={value:e[t],time:Date.now()};Object.defineProperty(e,t,{get:()=>{const e=i.time-n.time;let t=s[0],o=s[0];for(const n of s)e>n.time&&n.time>t.time&&(t=n),e<n.time&&n.time<o.time&&(o=n);const r=(e-t.time)/(o.time-t.time),a=t.progress+r*(o.progress-t.progress);return Number.isNaN(a)?n.value:i.value*a+n.value*(1-a)},set:e=>Date.now()-i.time<10?(i.value=e,!0):(n=Object.assign({},i),i={value:e,time:Date.now()},!0)})},t.BuildConstraint=function(e,t){return"min"==e?e=>e>=t[0]?e:t[0]:"max"==e?e=>e<=t[0]?e:t[0]:e=>e},t.isProxy=Symbol("isProxy"),t.EditWrapper=class{constructor(e){this.data=e}}}},t={};function s(n){var i=t[n];if(void 0!==i)return i.exports;var o=t[n]={exports:{}};return e[n](o,o.exports,s),o.exports}var n={};return(()=>{var e=n;const t=s(210),i=s(787),o=s(376);e.default=new class{constructor(){this.Start="_start",this.Connection="_connection",this.Lerp=i.Lerp,this.Interpolate=i.Interpolate,this.ws=new WebSocket("ws://localhost:8080/"),this.ping=0,this.events=new Map,this.self={},this.constraintTable={},this.controller=new o.Controller(this.ws),this.ws.onmessage=e=>{const s=t.Message.Parse(e.data);if(this.ping=2*(Date.now()-s.time),s.native)return this.parseNativeEvent(s);s.name in this.events&&this.events[s.name](s.data)}}on(e,t){var s;const n=null!==(s=this.events.get(e))&&void 0!==s?s:[];n.push(t),this.events.set(e,n)}send(e,s){"_"===e[0]&&(e="_"+e),this.ws.send(t.Message.Create(e,s))}parseNativeEvent(e){var t,s;for(const n of e.data)if("init"==n.instruction)this.uuid=n.client.uuid,this.joinTime=n.client.joinTime,this.self=n.client.self,this.unpackConstraints(n.constraintTable),this.controller.addUnpacked(n.client.controller),this.clients=n.clients,this.setupClientProxy(),(null!==(t=this.events.get(this.Start))&&void 0!==t?t:[]).forEach((e=>e()));else if("edit"==n.instruction){let e=this.clients;n.path.unshift(n.uuid);for(const t of n.path.slice(0,-1))e=e[t];e[n.path.slice(-1)[0]]=e[i.isProxy]?new i.EditWrapper(n.value):n.value}else"conn"==n.instruction&&(this.clients[n.uuid]=n.data,(null!==(s=this.events.get(this.Connection))&&void 0!==s?s:[]).forEach((e=>e(n.data))))}unpackConstraints(e){!function e(t,s,n){for(const[o,r]of Object.entries(s)){if("object"==typeof t[o]){e(t[o],r,n[o]={});continue}const s=n[o]={};for(const[e,t]of Object.entries(r))s[e]=(0,i.BuildConstraint)(e,t)}}(this.self,e,this.constraintTable)}setupClientProxy(){const e=new WeakSet,s=this;this.self=function n(o,r=[]){let a=s.constraintTable;for(const e of r){if(!(e in a))break;a=a[e]}for(const[e,t]of Object.entries(a))"lerp"in t&&s.Lerp(o,e),"interpolate"in t&&s.Interpolate(o,e,t.interpolate);return new Proxy(o,{get:(t,s)=>s===i.isProxy||("object"!=typeof o[s]||e.has(o[s])||(o[s]=n(o[s],[...r,s]),e.add(o[s])),o[s]),set(e,n,c){if(c===o[n])return!0;if(c instanceof i.EditWrapper)return o[n]=c.data,!0;if(!(n in o)||"object"==typeof c)throw new Error(`Cannot alter shape of Multyx object shared with server. Attempting to set ${r.join(".")+"."+n} to ${c}`);let l=c;if(n in a)for(const e of Object.values(a[n]))l=e(l);return o[n]===l||(o[n]=l,s.ws.send(t.Message.Native({instruction:"edit",path:[...r,n],value:l}))),!0},deleteProperty(){throw new Error("Cannot alter shape of Multyx object shared with server")}})}(this.self),this.clients[this.uuid]=this.self}}})(),n.default})()));